---
title: "Final project - Data Cleaning"
author: ""
date: "5/6/22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      error = FALSE,
                      warning = FALSE)
```

```{r}
library(tidyverse)
library(here)
library(rio)
library(janitor)
library(stringr)

#importing meta-data
ff_meta <- import(here("data","FFMetadata_v09.csv"))%>%
   clean_names() %>%
  as_tibble()
```

The actual data file has more than 17000 variables. We'll use the meta-data file to select the variable of interest, and use the `ff_vars` vector to subset the actual data file.

For this project, we're interested in:

1. Demographic characteristics 
a. self-reported race/ethnicity at age 15
b. mother's report on gender at birth

2. Scales:
a. Self-Description Questionnaire (SDQ) - Information on internalizing and externalizing behaviors at age 9
b. Delinquent Behavior Scale at age 9 and age 15
c. Aggravation in parenting - collected for Baseline all years

3. Outcomes from questionnaire
a. If child suspended/expelled, and number of times suspended or expelled at age 9 (parent report) and at age 15 (parent and child)


```{r}
#select scales
scales <- c("Aggravation in Parents", 
            "Self-Description Questionnaire (SDQ)",
            "Delinquent Behavior") 

ff_meta_subset <- ff_meta %>% 
                #demographic characteristics - race/ethnicity
                filter((topics == "Demographics" &
                        str_detect(varlab,"self-description of race/ethnicity"))|
                        #gender
                        (subtopics == "sex/gender" &
                        str_detect(varlab, "Focal baby's gender"))|
                        #scales
                        scale %in% scales|
                        #outcomes from questionnaire
                        (source == "questionnaire" & 
                        subtopics == "student experiences" &
                        str_detect(varlab,"suspen")))%>% 
                #only include relevant columns
                select(new_name, varlab, topics, subtopics, 
                       type, scale, source, respondent, 
                       survey, wave,
                       starts_with("label"))

```

Our meta-data subset includes the following information:

a. variable names corresponding to columns in the actual data set
b. variable labels - actual question statement
c. topics
d. subtopic
e. type - types of variable (continuous, categorical, etc.)
f. scale - which scale was used. "" means no scale was used
g. source 
h. respondent
i. survey
j. wave - year and wave data was collected
k. starts_with("label") - description of possible responses to questions and how they're coded.


```{r, eval = FALSE}
#use variable names to subset the dataset

ff_vars <- ff_meta_subset$new_name

ff <- import(here("data","FF_allwaves_2020v2_SPSS.sav")) %>% 
    clean_names()

ff_sub <- ff %>% 
    select(idnum, #identifier 
           all_of(ff_vars)) %>%  #our selected variables
    as_tibble()

```

```{r}
#let's save the subsetted df so that we don't have to clean each time

#export(ff_sub, here("data","ff_sub.Rda"))

ff_sub <- import(here("data","ff_sub.Rda"))
```

The variables (columns) have the following attributes:

a. label: variable label
b. names: possible responses for a question

```{r}
#let's join the meta data to the subset so that we know which scale it comes from

ff_sub_long <- ff_sub %>% 
    pivot_longer(
        cols = -1,
        names_to = "response"
    ) %>% 
    left_join(ff_meta, by = c("response" = "new_name"))

```


```{r}
#Let's make some example plots

plots <- ff_sub_long %>% 
    filter(scale == "Self-Description Questionnaire (SDQ)" & value >=0) %>%
    nest_by(varlab) %>% 
    summarise(
        plot = list(
            ggplot(data, aes(x = as.factor(value)))+
            geom_bar()+
            labs(
                title = glue::glue("{varlab}")
            )   
        )
    )

walk(plots$plot,print)



```
## Calculate subscores
```{r calculate-subscores}

#Calculates subscores for internalizing and externalizing behaviors at age 9
ff_sub <- ff_sub %>% 
mutate(int_scores = (k5g2a + k5g2c + k5g2e + k5g2g + k5g2i + k5g2j + k5g2k + k5g2l)/8, ext_scores = (k5g2b + k5g2d + k5g2f + k5g2h + k5g2m + k5g2n)/6) %>%
filter(int_scores >=0, ext_scores >= 0)


#Subsetting: select int/ext scores, sex, ethnicity, delinquent behaviors, expulsions/suspensions and filter by valid scores (i.e., less than 0)
ff_sub_lm <- ff_sub %>% 
    rowwise() %>% 
    select(idnum, starts_with("k6d6"), starts_with("k5f1"), int_scores, ext_scores, cm1bsex, ck6ethrace, p5l12g, p6c21) %>% 
    filter(rowSums(across(where(is.numeric)))>=0 & ck6ethrace >=0 & p5l12g >=0 & p6c21 >=0) %>% 
    mutate(del_beh_9 = sum(c_across(starts_with("k5f1"))),
    del_beh_15 = sum(c_across(starts_with("k6d6"))))
```
## Function: calculate mean across variables
```{r function-mean-null}
means_df <- function(df, ...) {
    means <- map(df, mean, ...) 
    nas <- map_lgl(means, is.na)
    means_l <- means[!nas] 
    as.data.frame(means_l) 
}

means_df(ff_sub)

```
## Linear Model functions
```{r lm-models}
ff_sub_lm$idnum <- as.numeric(ff_sub_lm$idnum)
ff_sub_lm$ck6ethrace <- as.numeric(ff_sub_lm$ck6ethrace)

lm_mods <- function (vardep, varindep1, varindep2, varindep3, DATA) {
  summary(lm(paste(vardep, "~", varindep1, "+", varindep2, "+", varindep3), data = DATA))
  }

lm_mods("del_beh_15", "ext_scores", "cm1bsex", "ck6ethrace", ff_sub_lm)
lm_mods("del_beh_15", "int_scores", "cm1bsex", "ck6ethrace", ff_sub_lm)
lm_mods("del_beh_9", "int_scores", "cm1bsex", "ck6ethrace", ff_sub_lm)
lm_mods("del_beh_9", "ext_scores", "cm1bsex", "ck6ethrace", ff_sub_lm)

lm_mods("p5l12g", "ext_scores", "cm1bsex", "ck6ethrace", ff_sub_lm)
lm_mods("p5l12g", "int_scores", "cm1bsex", "ck6ethrace", ff_sub_lm)
lm_mods("p6c21", "ext_scores", "cm1bsex", "ck6ethrace", ff_sub_lm)
lm_mods("p6c21", "ext_scores", "cm1bsex", "ck6ethrace", ff_sub_lm)


mod_db_int_15 <- ff_sub_lm %>%
    group_by(idnum) %>%
    nest() %>%
    mutate(
        model = map(
            data, ~lm(del_beh_15 ~ int_scores + cm1bsex + ck6ethrace, data = .x)
        )
    )

mod_db_ext_15 <- ff_sub_lm %>%
    group_by(idnum) %>%
    nest() %>%
    mutate(
        model = map(
            data, ~lm(del_beh_15 ~ ext_scores + cm1bsex + ck6ethrace, data = .x)
        )
    )

mod_db_int_9 <- ff_sub_lm %>%
    group_by(idnum) %>%
    nest() %>%
    mutate(
        model = map(
            data, ~lm(del_beh_9 ~ int_scores + cm1bsex + ck6ethrace, data = .x)
        )
    )

mod_db_ext_9 <- ff_sub_lm %>%
    group_by(idnum) %>%
    nest() %>%
    mutate(
        model = map(
            data, ~lm(del_beh_9 ~ ext_scores + cm1bsex + ck6ethrace, data = .x)
        )
    )

mod_expulsion9_int <- ff_sub_lm %>%
    group_by(idnum) %>%
    nest() %>%
    mutate(
        model = map(
            data, ~lm(p5l12g ~ int_scores + cm1bsex + ck6ethrace, data = .x)
        )
    )

mod_expulsion15_ext <- ff_sub_lm %>%
    group_by(idnum) %>%
    nest() %>%
    mutate(
        model = map(
            data, ~lm(p6c21 ~ ext_scores + cm1bsex + ck6ethrace, data = .x)
        )
    )

mod_expulsion9_ext <- ff_sub_lm %>%
    group_by(idnum) %>%
    nest() %>%
    mutate(
        model = map(
            data, ~lm(p5l12g ~ ext_scores + cm1bsex + ck6ethrace, data = .x)
        )
    )

mod_expulsion15_int <- ff_sub_lm %>%
    group_by(idnum) %>%
    nest() %>%
    mutate(
        model = map(
            data, ~lm(p6c21 ~ int_scores + cm1bsex + ck6ethrace, data = .x)
        )
    )

pull_coef <- function(model, coef_name) {
    coef(model)[coef_name]
}

mod_db_ext_15 %>%
    mutate(intercept = map_dfr(model, pull_coef))

mod_db_int_15 %>%
    mutate(intercept = map_dfr(model, pull_coef))

mod_db_ext_9 %>%
    mutate(intercept = map_dfr(model, pull_coef))

mod_db_int_9 %>%
    mutate(intercept = map_dfr(model, pull_coef))

mod_expulsion15_ext %>%
    mutate(intercept = map_dfr(model, pull_coef))

mod_expulsion15_int%>%
    mutate(intercept = map_dfr(model, pull_coef))

mod_expulsion9_ext %>%
    mutate(intercept = map_dfr(model, pull_coef))

mod_expulsion9_int%>%
    mutate(intercept = map_dfr(model, pull_coef))


mods <- function(data, x, y, points = FALSE, ...) {
    p <- ggplot(data, aes({{x}}, {{y}})) 
    p + geom_smooth(method = "lm",
                    color = "magenta", 
                    ...) +
        geom_smooth(...)
}
```

## Internalizing year 9 x delinquency behaviors in year 15 

```{r lm-model-int-15}
mods(ff_sub_lm, int_scores, del_beh_15) +
    labs(title = "Relationship between Internalizing year 9 x suspensions/expulsions in year 15",
         x = "Internalizing behavior score",
         y = "Delinquency behaviors")
```
## Externalizing behaviors year 9 x delinquency behaviors in year 15

```{r lm-model-ext-15}
mods(ff_sub_lm, ext_scores, del_beh_15) +
    labs(title = "Relationship between Externalizing year 9 x suspensions/expulsions in year 15",
         x = "Externalizing behavior score",
         y = "Delinquency behaviors")

```
## Internalizing year 9 x delinquency behaviors in year 15 

```{r lm-model-int-9}
mods(ff_sub_lm, int_scores, del_beh_9) +
    labs(title = "Relationship between Internalizing year 9 x suspensions/expulsions in year 9",
         x = "Internalizing behavior score",
         y = "Delinquency behaviors")
```
## Externalizing behaviors year 9 x delinquency behaviors in year 15

```{r lm-model-ext-9}
mods(ff_sub_lm, ext_scores, del_beh_9) +
    labs(title = "Relationship between Externalizing year 9 x suspensions/expulsions in year 9",
         x = "Externalizing behavior score",
         y = "Delinquency behaviors")

```
## Internalizing year 9 x suspensions/expulsions in year 9

```{r lm-model-int-exp-15}
mods(ff_sub_lm, int_scores, p5l12g) +
    labs(title = "Relationship between Internalizing year 9 x suspensions/expulsions in year 9",
         x = "Internalizing behavior score",
         y = "suspensions/expulsions")
```
## Externalizing behaviors year 9 x suspensions/expulsions in year 9

```{r lm-model-ext-exp-15}
mods(ff_sub_lm, ext_scores, p5l12g) +
    labs(title = "Relationship between Externalizing year 9 x suspensions/expulsions in year 9",
         x = "Externalizing behavior score",
         y = "suspensions/expulsions")

```
## Internalizing year 9 x duspensions/expulsions in year 15 

```{r lm-model-int-exp-9}
mods(ff_sub_lm, int_scores, p6c21) +
    labs(title = "Relationship between Internalizing year 9 x suspensions/expulsions in year 15",
         x = "Internalizing behavior score",
         y = "suspensions/expulsions")
```
## Externalizing behaviors year 9 x uspensions/expulsions in year 15

```{r lm-model-ext-exp-9}
mods(ff_sub_lm, ext_scores, p6c21) +
    labs(title = "Relationship between Externalizing year 9 x suspensions/expulsions in year 15",
         x = "Externalizing behavior score",
         y = "suspensions/expulsions")

```
